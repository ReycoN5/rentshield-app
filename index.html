<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Remnawave</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, query, where, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAkRl7PNxZHQIPiqCbmoTbOdLteKJ8DWwI",
        authDomain: "servicehub-e6821.firebaseapp.com",
        projectId: "servicehub-e6821",
        storageBucket: "servicehub-e6821.firebasestorage.app",
        messagingSenderId: "208780669426",
        appId: "1:208780669426:web:3f141d0d6eecef1a397b6b"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const ADMIN_IDS = [935754023];

      const PLANS = [
        { id: 'month1', name: '1 –º–µ—Å—è—Ü', price: 300, duration: '30 –¥–Ω–µ–π' },
        { id: 'month3', name: '3 –º–µ—Å—è—Ü–∞', price: 800, duration: '90 –¥–Ω–µ–π' },
        { id: 'month6', name: '6 –º–µ—Å—è—Ü–µ–≤', price: 1200, duration: '180 –¥–Ω–µ–π' }
      ];

      const PHONE_NUMBER = "+7 (999) 123-45-67"; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π

      const App = {
        user: null,
        currentTab: 'subscriptions',
        selectedPlan: null,
        pendingRequest: null,
        subscriptions: [],
        tickets: [], // New: Store user support tickets
        db
      };

      App.initTelegram = () => {
        if (!window.Telegram?.WebApp) return;
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        // Allow Telegram to control the background color for seamless integration
        Telegram.WebApp.setBackgroundColor(Telegram.WebApp.themeParams.bg_color || '#000000');
        Telegram.WebApp.setHeaderColor(Telegram.WebApp.themeParams.bg_color || '#000000');
        
        const tp = Telegram.WebApp.themeParams;
        if (tp) {
          const root = document.documentElement;
          Object.keys(tp).forEach(key => root.style.setProperty(`--tg-theme-${key.replace(/_/g, '-')}`, tp[key]));
        }
      };

      App.showToast = (msg) => {
        const t = document.getElementById('toast');
        // Reset animation
        t.style.animation = 'none';
        t.offsetHeight; /* trigger reflow */
        t.style.animation = null;
        
        t.textContent = msg;
        t.classList.add('show');
        
        if (App.toastTimeout) clearTimeout(App.toastTimeout);
        App.toastTimeout = setTimeout(() => t.classList.remove('show'), 3000);
      };

      App.haptic = (type = 'light') => {
        const valid = ['light', 'medium', 'heavy'];
        if (valid.includes(type) && Telegram?.WebApp?.isVersionAtLeast?.('6.1')) {
          Telegram.WebApp.HapticFeedback.impactOccurred(type);
        }
      };

      App.autoLogin = async () => {
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        if (!tgUser || !tgUser.id) {
          document.getElementById('content').innerHTML = '<div class="empty-state"><div class="icon-box">‚ö†Ô∏è</div><p class="hint">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ Telegram</p></div>';
          return;
        }
        const userId = tgUser.id.toString();
        const username = tgUser.username || tgUser.first_name || 'User';
        const role = ADMIN_IDS.includes(tgUser.id) ? 'admin' : 'user';
        await setDoc(doc(db, "users", userId), { username, role, telegramId: tgUser.id, lastLogin: serverTimestamp() }, { merge: true });
        App.user = { id: userId, username, role };
        document.getElementById('admin-tab').style.display = role === 'admin' ? 'flex' : 'none';
        const nav = document.querySelector('.bottom-nav');
        nav.style.display = 'flex';
        // Force reflow for animation
        void nav.offsetWidth;
        nav.classList.add('show');
        App.loadUserData();
        App.renderCurrentTab();
        App.haptic('light');
        // Removed initial toast to keep UI clean on load
        // App.showToast(`–ü—Ä–∏–≤–µ—Ç, ${username}`);
      };

      App.loadUserData = () => {
        // Load Subscriptions
        onSnapshot(query(collection(db, "subscriptions"), where("userId", "==", App.user.id)), (snap) => {
          App.subscriptions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          if (App.currentTab === 'subscriptions') App.renderCurrentTab();
        });
        // Load Pending Payments
        onSnapshot(query(collection(db, "paymentRequests"), where("userId", "==", App.user.id), where("status", "==", "pending")), (snap) => {
          App.pendingRequest = snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() };
          document.getElementById('status-badge').classList.toggle('show', !!App.pendingRequest);
          if (App.currentTab === 'subscriptions') App.renderCurrentTab();
        });
        // New: Load Support Tickets
        onSnapshot(query(collection(db, "supportTickets"), where("userId", "==", App.user.id), orderBy("createdAt", "desc")), (snap) => {
          App.tickets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          if (App.currentTab === 'support') App.renderCurrentTab();
        });
      };

      App.showPaymentModal = (plan) => {
        App.selectedPlan = plan;
        document.getElementById('modal-title').textContent = plan.name;
        document.getElementById('modal-price').textContent = `${plan.price} ‚ÇΩ`;
        document.getElementById('modal-phone').textContent = PHONE_NUMBER;
        document.getElementById('payment-modal').classList.add('show');
        App.haptic('medium');
      };

      App.copyPhone = () => {
        navigator.clipboard.writeText(PHONE_NUMBER);
        App.showToast('–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
        App.haptic('light');
      };

      App.confirmPayment = async () => {
        if (App.pendingRequest) {
          App.showToast('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
          return;
        }
        const ref = doc(collection(db, "paymentRequests"));
        await setDoc(ref, {
          userId: App.user.id,
          username: App.user.username,
          planId: App.selectedPlan.id,
          planName: App.selectedPlan.name,
          price: App.selectedPlan.price,
          status: 'pending',
          createdAt: serverTimestamp()
        });
        document.getElementById('payment-modal').classList.remove('show');
        App.showToast('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
      };

      // New: Submit Support Ticket
      App.submitTicket = async () => {
        const input = document.getElementById('ticket-message');
        const message = input.value.trim();
        if (!message) return;

        const btn = document.getElementById('submit-ticket-btn');
        btn.disabled = true;
        btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

        try {
            await setDoc(doc(collection(db, "supportTickets")), {
                userId: App.user.id,
                username: App.user.username,
                message: message,
                status: 'open',
                createdAt: serverTimestamp()
            });
            input.value = '';
            App.showToast('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            App.haptic('medium');
        } catch (e) {
            console.error(e);
            App.showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        } finally {
            btn.disabled = false;
            btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å';
        }
      };

      // New: Admin Reply/Update Ticket
      App.adminUpdateTicket = async (ticketId, action) => {
        const ref = doc(db, "supportTickets", ticketId);
        
        if (action === 'close') {
            await updateDoc(ref, { status: 'closed' });
            App.showToast('–¢–∏–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç');
        } else if (action === 'reply') {
            const replyInput = document.getElementById(`reply-${ticketId}`);
            const reply = replyInput.value.trim();
            if (!reply) return;
            
            await updateDoc(ref, { 
                adminReply: reply,
                status: 'answered'
            });
            App.showToast('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        }
        App.renderAdminPanel(); // Refresh admin view
      };

      App.renderCurrentTab = () => {
        const content = document.getElementById('content');
        const title = document.getElementById('page-title');
        content.innerHTML = '';
        title.textContent = ''; // Title is handled in the header now

        // Update Header Title based on Tab
        const headerTitle = document.getElementById('header-title');

        if (App.currentTab === 'subscriptions') {
          headerTitle.textContent = '–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏';
          if (App.subscriptions.length === 0) {
            content.innerHTML = `
                <div class="empty-state fade-in">
                    <div class="icon-box">üîç</div>
                    <p class="hint">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>
                    <button class="btn primary" onclick="document.querySelector('[data-tab=purchase]').click()">–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
                </div>`;
          } else {
            App.subscriptions.forEach(sub => {
              const card = document.createElement('div');
              card.className = 'card subscription-card fade-in';
              card.innerHTML = `
                <div class="card-header">
                    <h3>${sub.planName}</h3>
                    <span class="status active">–ê–∫—Ç–∏–≤–Ω–∞</span>
                </div>
                ${sub.connectionLink ? `
                    <div class="link-container">
                        <div class="link-label">–°—Å—ã–ª–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                        <p class="link text-truncate">${sub.connectionLink}</p>
                    </div>` : ''}
                ${sub.qrBase64 ? `<div class="qr-container"><img src="${sub.qrBase64}" class="qr"></div>` : ''}
                <div class="card-actions">
                    ${sub.connectionLink ? `<button class="btn secondary" onclick="navigator.clipboard.writeText('${sub.connectionLink}'); App.showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>` : ''}
                </div>
              `;
              content.appendChild(card);
            });
          }
        } else if (App.currentTab === 'purchase') {
          headerTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ';
          const grid = document.createElement('div');
          grid.className = 'plans-grid';
          
          PLANS.forEach(plan => {
            const card = document.createElement('div');
            card.className = 'plan-card fade-in';
            card.onclick = () => App.showPaymentModal(plan);
            card.innerHTML = `
              <div class="plan-info">
                  <h3>${plan.name}</h3>
                  <p class="duration">${plan.duration}</p>
              </div>
              <div class="plan-price">
                ${plan.price} ‚ÇΩ
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
              </div>
            `;
            grid.appendChild(card);
          });
          content.appendChild(grid);
        } else if (App.currentTab === 'tutorial') {
          headerTitle.textContent = '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è';
          content.innerHTML = `
            <div class="tutorial-list fade-in">
                <div class="tutorial-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>–°–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
                        <p>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ v2RayTun –∏–∑ AppStore –∏–ª–∏ Google Play</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á</h3>
                        <p>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏" –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å</h3>
                        <p>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–ª—é—á –≤—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.</p>
                    </div>
                </div>
            </div>
          `;
        } else if (App.currentTab === 'support') {
           // New: Support Tab Content
           headerTitle.textContent = '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';
           
           // Form
           const formDiv = document.createElement('div');
           formDiv.className = 'card fade-in';
           formDiv.innerHTML = `
             <h3 style="margin-bottom:12px;">–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</h3>
             <textarea id="ticket-message" class="styled-input" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
             <button id="submit-ticket-btn" class="btn primary" onclick="App.submitTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
           `;
           content.appendChild(formDiv);

           // List
           if (App.tickets.length > 0) {
               const listTitle = document.createElement('h3');
               listTitle.className = 'section-title';
               listTitle.textContent = '–í–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã';
               content.appendChild(listTitle);

               App.tickets.forEach(ticket => {
                   const tCard = document.createElement('div');
                   tCard.className = 'card fade-in';
                   
                   let statusClass = 'neutral';
                   let statusText = '–û—Ç–∫—Ä—ã—Ç';
                   if(ticket.status === 'answered') { statusClass = 'active'; statusText = '–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω'; }
                   if(ticket.status === 'closed') { statusClass = 'closed'; statusText = '–ó–∞–∫—Ä—ã—Ç'; }

                   tCard.innerHTML = `
                     <div class="card-header">
                        <span class="status ${statusClass}">${statusText}</span>
                        <span class="date-badge">${ticket.createdAt?.toDate()?.toLocaleDateString() || ''}</span>
                     </div>
                     <p style="margin-bottom:8px; font-weight:500;">${ticket.message}</p>
                     ${ticket.adminReply ? `
                        <div class="admin-reply">
                            <div class="reply-label">–û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏:</div>
                            <p>${ticket.adminReply}</p>
                        </div>
                     ` : ''}
                   `;
                   content.appendChild(tCard);
               });
           }

        } else if (App.currentTab === 'admin') {
          if (App.user.role !== 'admin') return;
          headerTitle.textContent = '–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å';
          content.innerHTML = '<div class="loader"></div>';
          App.renderAdminPanel();
        }
      };

      App.renderAdminPanel = async () => {
        const content = document.getElementById('content');
        content.innerHTML = '';
        
        // --- Payments Section ---
        const paySnap = await getDocs(query(collection(db, "paymentRequests"), where("status", "==", "pending")));
        
        const payTitle = document.createElement('h3');
        payTitle.className = 'section-title fade-in';
        payTitle.textContent = `–ó–∞—è–≤–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É (${paySnap.size})`;
        content.appendChild(payTitle);

        if (paySnap.empty) {
          content.innerHTML += `<div class="empty-state fade-in" style="padding: 20px;"><p class="hint">–ù–µ—Ç –∑–∞—è–≤–æ–∫</p></div>`;
        } else {
            paySnap.forEach(d => {
              const req = { id: d.id, ...d.data() };
              const card = document.createElement('div');
              card.className = 'card admin-card fade-in';
              card.innerHTML = `
                <div class="admin-header">
                    <div>
                        <p class="username">@${req.username || '–ë–µ–∑ —é–∑–µ—Ä–Ω–µ–π–º–∞'}</p>
                        <p class="user-id">ID: ${req.userId}</p>
                    </div>
                    <div class="date-badge">${req.createdAt?.toDate()?.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) || 'Now'}</div>
                </div>
                <div class="admin-body">
                    <p class="hint" style="margin-bottom:8px;">–ü–ª–∞–Ω: ${req.planName} (${req.price}‚ÇΩ)</p>
                    <div class="input-group">
                        <input type="text" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ vless:// —Å—Å—ã–ª–∫—É" id="link-${req.id}" class="styled-input">
                    </div>
                    <div class="file-group">
                        <label for="qr-${req.id}" class="file-label">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å QR
                        </label>
                        <input type="file" accept="image/*" id="qr-${req.id}" class="hidden-input">
                    </div>
                    <div id="preview-${req.id}" class="preview-area"></div>
                </div>
                <button class="btn primary small" onclick="App.confirmPayment('${req.id}')">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –≤—ã–¥–∞—Ç—å</button>
              `;
              content.appendChild(card);
              
              const fileInput = document.getElementById(`qr-${req.id}`);
              fileInput.onchange = e => {
                const file = e.target.files[0];
                const label = fileInput.previousElementSibling;
                if (file) {
                  label.style.borderColor = 'var(--tg-theme-button-color)';
                  label.style.color = 'var(--tg-theme-button-color)';
                  label.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> ${file.name.substring(0, 10)}...`;
                  
                  const reader = new FileReader();
                  reader.onload = ev => document.getElementById(`preview-${req.id}`).innerHTML = `<img src="${ev.target.result}" class="qr-preview">`;
                  reader.readAsDataURL(file);
                }
              };
            });
        }

        // --- Support Tickets Section ---
        const ticketSnap = await getDocs(query(collection(db, "supportTickets"), orderBy("createdAt", "desc")));
        // Filter out closed tickets locally or via query if needed. Showing all for now.
        
        const supportTitle = document.createElement('h3');
        supportTitle.className = 'section-title fade-in';
        supportTitle.style.marginTop = '32px';
        supportTitle.textContent = `–¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏`;
        content.appendChild(supportTitle);

        if(ticketSnap.empty) {
             content.innerHTML += `<div class="empty-state fade-in" style="padding: 20px;"><p class="hint">–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤</p></div>`;
        } else {
             ticketSnap.forEach(d => {
                 const t = { id: d.id, ...d.data() };
                 if (t.status === 'closed') return; // Optional: Hide closed tickets to keep admin clean

                 const tCard = document.createElement('div');
                 tCard.className = 'card admin-card fade-in';
                 tCard.innerHTML = `
                    <div class="admin-header">
                        <div>
                             <p class="username">@${t.username || 'User'}</p>
                             <p class="user-id">Status: <span style="color:var(--tg-theme-button-color)">${t.status}</span></p>
                        </div>
                        <div class="date-badge">${t.createdAt?.toDate()?.toLocaleDateString()}</div>
                    </div>
                    <div class="admin-body">
                        <p style="margin-bottom:12px; background:rgba(255,255,255,0.05); padding:8px; border-radius:8px;">${t.message}</p>
                        ${t.adminReply ? `<p class="hint" style="margin-bottom:8px;">–í–∞—à –æ—Ç–≤–µ—Ç: ${t.adminReply}</p>` : ''}
                        
                        <div class="input-group">
                            <input type="text" id="reply-${t.id}" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞..." class="styled-input">
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn primary small" onclick="App.adminUpdateTicket('${t.id}', 'reply')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                            <button class="btn secondary small" onclick="App.adminUpdateTicket('${t.id}', 'close')" style="color:#ff3b30">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                 `;
                 content.appendChild(tCard);
             });
        }
      };

      App.onPaidClick = async () => {
        if (App.pendingRequest) return App.showToast('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
        const ref = doc(collection(db, "paymentRequests"));
        await setDoc(ref, { userId: App.user.id, username: App.user.username, status: 'pending', createdAt: serverTimestamp() });
        App.showToast('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
      };

      window.App = App;

      App.confirmPayment = async (id) => {
        const link = document.getElementById(`link-${id}`).value.trim();
        const qrFile = document.getElementById(`qr-${id}`).files[0];
        let qrBase64 = '';
        if (qrFile) {
          qrBase64 = await new Promise(r => {
            const reader = new FileReader();
            reader.onload = e => r(e.target.result);
            reader.readAsDataURL(qrFile);
          });
        }
        if (!link && !qrBase64) return App.showToast('–î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ QR');
        const req = await getDoc(doc(db, "paymentRequests", id));
        await setDoc(doc(collection(db, "subscriptions")), {
          userId: req.data().userId,
          planName: '–ü—Ä–µ–º–∏—É–º',
          status: 'active',
          connectionLink: link,
          qrBase64,
          createdAt: serverTimestamp()
        });
        await updateDoc(doc(db, "paymentRequests", id), { status: 'confirmed' });
        App.showToast('–ü–æ–¥–ø–∏—Å–∫–∞ –≤—ã–¥–∞–Ω–∞');
        App.renderAdminPanel();
      };

      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', e => {
            document.querySelector('.nav-item.active')?.classList.remove('active');
            e.currentTarget.classList.add('active');
            App.currentTab = e.currentTarget.dataset.tab;
            
            // Add slight bump animation to icon
            const icon = e.currentTarget.querySelector('svg');
            icon.style.transform = 'scale(1.2)';
            setTimeout(() => icon.style.transform = 'scale(1)', 200);

            App.renderCurrentTab();
            App.haptic('light');
            });
        });

        // Close modal on click outside
        document.getElementById('payment-modal').addEventListener('click', (e) => {
            if(e.target.id === 'payment-modal') {
                e.target.classList.remove('show');
            }
        });

        App.initTelegram();
        App.autoLogin();
      });
    </script>

    <style>
      /* --- Variables & Reset --- */
      :root {
        /* Default Dark Theme Fallback */
        --tg-theme-bg-color: #000000;
        --tg-theme-secondary-bg-color: #1c1c1e;
        --tg-theme-text-color: #ffffff;
        --tg-theme-hint-color: #98989d;
        --tg-theme-link-color: #0a84ff;
        --tg-theme-button-color: #0a84ff;
        --tg-theme-button-text-color: #ffffff;
        
        --safe-area-top: env(safe-area-inset-top, 20px);
        --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        
        --radius-l: 24px;
        --radius-m: 16px;
        --radius-s: 12px;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--tg-theme-bg-color);
        color: var(--tg-theme-text-color);
        min-height: 100vh;
        overflow-x: hidden;
        /* Subtle gradient background for premium feel */
        background-image: radial-gradient(circle at 50% 0%, rgba(10, 132, 255, 0.15), transparent 60%);
        background-attachment: fixed;
      }

      /* --- Layout --- */
      .container {
        padding: calc(var(--safe-area-top) + 20px) 16px calc(var(--safe-area-bottom) + 90px);
        max-width: 600px;
        margin: 0 auto;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* --- Typography --- */
      h2#page-title { display: none; } /* Hidden, replaced by sticky header */

      .header-title-container {
        margin-bottom: 24px;
        padding: 0 8px;
        animation: fadeIn 0.6s ease-out;
      }

      h1 {
        font-size: 32px;
        font-weight: 800;
        letter-spacing: -0.5px;
        background: linear-gradient(135deg, var(--tg-theme-text-color) 30%, var(--tg-theme-link-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .section-title {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--tg-theme-hint-color);
        margin: 24px 0 8px 12px;
        font-weight: 500;
      }

      /* --- Cards & Containers --- */
      .card {
        background: var(--tg-theme-secondary-bg-color);
        border-radius: var(--radius-l);
        padding: 20px;
        margin-bottom: 16px;
        position: relative;
        overflow: hidden;
        /* Subtle border for separation */
        box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
      }

      .plan-card {
        background: var(--tg-theme-secondary-bg-color);
        padding: 16px 20px;
        margin-bottom: 1px; /* Separator style */
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
      }
      
      .plan-card:first-child { border-top-left-radius: var(--radius-l); border-top-right-radius: var(--radius-l); }
      .plan-card:last-child { border-bottom-left-radius: var(--radius-l); border-bottom-right-radius: var(--radius-l); margin-bottom: 16px; }
      
      .plans-grid {
        display: flex;
        flex-direction: column;
        border-radius: var(--radius-l);
        overflow: hidden;
        background: var(--tg-theme-secondary-bg-color); /* For the gaps */
      }

      .plan-card:active {
        background: rgba(255,255,255,0.05);
      }

      .plan-info h3 { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
      .plan-info .duration { font-size: 14px; color: var(--tg-theme-hint-color); }
      
      .plan-price {
        font-size: 17px;
        font-weight: 600;
        color: var(--tg-theme-button-color);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .subscription-card {
        border: 1px solid rgba(255,255,255,0.05);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      
      .card-header h3 { font-size: 20px; font-weight: 700; }

      .status {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 100px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .status.active { background: rgba(52, 199, 89, 0.2); color: #32d74b; }
      .status.neutral { background: rgba(255, 255, 255, 0.1); color: var(--tg-theme-text-color); }
      .status.closed { background: rgba(255, 59, 48, 0.2); color: #ff3b30; }

      .link-container {
        background: rgba(0,0,0,0.2);
        padding: 12px;
        border-radius: var(--radius-s);
        margin-bottom: 16px;
      }
      
      .link-label { font-size: 11px; color: var(--tg-theme-hint-color); margin-bottom: 4px; text-transform: uppercase; }
      .link { font-family: monospace; font-size: 14px; color: var(--tg-theme-text-color); word-break: break-all; opacity: 0.9; }
      .text-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

      .qr-container { display: flex; justify-content: center; margin: 16px 0; background: #fff; padding: 12px; border-radius: var(--radius-m); width: fit-content; margin: 16px auto;}
      .qr { width: 140px; height: 140px; display: block; }
      .qr-preview { max-width: 100%; border-radius: var(--radius-s); margin-top: 12px; }

      .admin-reply {
          background: rgba(10, 132, 255, 0.1);
          border-left: 3px solid var(--tg-theme-button-color);
          padding: 12px;
          border-radius: 0 var(--radius-s) var(--radius-s) 0;
          margin-top: 12px;
      }
      .reply-label { font-size:11px; font-weight:700; color: var(--tg-theme-button-color); margin-bottom:4px; text-transform:uppercase;}

      /* --- Buttons --- */
      .btn {
        width: 100%;
        padding: 16px;
        border-radius: var(--radius-m);
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s, opacity 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      .btn:active { transform: scale(0.98); opacity: 0.9; }

      .btn.primary {
        background: var(--tg-theme-button-color);
        color: var(--tg-theme-button-text-color);
        box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
      }

      .btn.secondary {
        background: rgba(255,255,255,0.08);
        color: var(--tg-theme-button-color);
        font-size: 15px;
        padding: 12px;
      }
      
      .btn.small { padding: 12px; font-size: 15px; }

      /* --- Inputs (Admin) --- */
      .styled-input {
        width: 100%;
        background: var(--tg-theme-bg-color);
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--tg-theme-text-color);
        padding: 14px;
        border-radius: var(--radius-s);
        font-size: 16px;
        outline: none;
        transition: border-color 0.2s;
        margin-bottom: 12px;
        font-family: inherit;
      }
      .styled-input:focus { border-color: var(--tg-theme-button-color); }
      textarea.styled-input { resize: vertical; min-height: 80px; }
      
      .file-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px;
        border: 2px dashed rgba(255,255,255,0.15);
        border-radius: var(--radius-s);
        color: var(--tg-theme-hint-color);
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 16px;
      }
      .hidden-input { display: none; }

      /* --- Tutorial --- */
      .tutorial-list { display: flex; flex-direction: column; gap: 24px; }
      .tutorial-step { display: flex; gap: 16px; }
      .step-number {
        width: 32px; height: 32px;
        background: var(--tg-theme-button-color);
        color: var(--tg-theme-button-text-color);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; flex-shrink: 0;
        font-size: 16px;
      }
      .step-content h3 { font-size: 17px; margin-bottom: 4px; font-weight: 600; }
      .step-content p { font-size: 15px; color: var(--tg-theme-hint-color); line-height: 1.4; }

      /* --- Empty State --- */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
      }
      .icon-box {
        font-size: 48px;
        margin-bottom: 8px;
        filter: grayscale(1);
        opacity: 0.5;
      }

      /* --- Bottom Navigation --- */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(28, 28, 30, 0.85); /* Fallback */
        background: var(--tg-theme-secondary-bg-color);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 0.5px solid rgba(255,255,255,0.1);
        padding: 8px 16px calc(var(--safe-area-bottom) + 4px);
        display: none;
        justify-content: space-between;
        z-index: 100;
        opacity: 0;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s;
      }
      .bottom-nav.show { opacity: 1; transform: translateY(0); }

      .nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4px;
        color: var(--tg-theme-hint-color);
        cursor: pointer;
        transition: color 0.2s;
        border-radius: 8px;
      }
      
      .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; transition: transform 0.2s; stroke-width: 2px; }
      .nav-item div { font-size: 10px; font-weight: 500; letter-spacing: 0.2px; }
      
      .nav-item.active { color: var(--tg-theme-button-color); }
      .nav-item.active svg { stroke: var(--tg-theme-button-color); }

      /* --- Modal --- */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        display: none;
        align-items: flex-end;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .modal.show { display: flex; opacity: 1; }
      
      .modal-content {
        background: var(--tg-theme-secondary-bg-color);
        width: 100%;
        max-width: 500px;
        border-radius: 32px 32px 0 0;
        padding: 32px 24px calc(var(--safe-area-bottom) + 24px);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .modal.show .modal-content { transform: translateY(0); }

      .modal-drag {
        width: 40px; height: 4px; background: rgba(255,255,255,0.2);
        border-radius: 2px; margin: 0 auto 24px;
      }

      .modal h3 { font-size: 24px; text-align: center; margin-bottom: 8px; }
      .modal .price { font-size: 42px; font-weight: 800; text-align: center; color: var(--tg-theme-text-color); margin: 24px 0; letter-spacing: -1px; }
      
      .modal-phone {
        background: var(--tg-theme-bg-color);
        padding: 20px;
        border-radius: var(--radius-m);
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        font-family: monospace;
        letter-spacing: 1px;
        margin: 16px 0 24px;
        border: 1px solid rgba(255,255,255,0.05);
      }

      /* --- Status Badge --- */
      #status-badge {
        position: fixed;
        top: calc(var(--safe-area-top) + 12px);
        right: 16px;
        background: rgba(255, 159, 10, 0.2);
        color: #ff9f0a;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 159, 10, 0.3);
        padding: 6px 12px;
        border-radius: 100px;
        font-weight: 600;
        font-size: 12px;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.4s;
        z-index: 90;
        pointer-events: none;
      }
      #status-badge.show { opacity: 1; transform: translateY(0); pointer-events: auto; }

      /* --- Toast --- */
      #toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: rgba(30, 30, 30, 0.9);
        color: #fff;
        padding: 16px 24px;
        border-radius: 16px;
        font-weight: 500;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        pointer-events: none;
        opacity: 0;
        transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 2000;
        text-align: center;
        max-width: 80%;
        backdrop-filter: blur(10px);
      }
      #toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

      /* --- Admin Specific --- */
      .admin-card { padding: 0; }
      .admin-header {
        padding: 16px;
        background: rgba(255,255,255,0.03);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.05);
      }
      .username { font-weight: 600; font-size: 15px; }
      .user-id { font-size: 12px; color: var(--tg-theme-hint-color); font-family: monospace; }
      .date-badge { font-size: 11px; color: var(--tg-theme-hint-color); }
      .admin-body { padding: 16px; }

      /* --- Animations --- */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .fade-in { animation: fadeIn 0.4s ease-out forwards; }
      
      .loader {
        width: 24px; height: 24px;
        border: 3px solid rgba(255,255,255,0.1);
        border-top-color: var(--tg-theme-button-color);
        border-radius: 50%;
        margin: 40px auto;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>
  <div id="main-app">
    <div id="status-badge">‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
    
    <div class="container">
      <div class="header-title-container">
          <h1 id="header-title">Remnawave</h1>
      </div>
      
      <h2 id="page-title">Remnawave</h2> <!-- Logic hook preserved -->
      
      <div id="content">
        <div class="loader"></div>
      </div>
    </div>
  </div>

  <!-- Payment Modal (Bottom Sheet style) -->
  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <div class="modal-drag"></div>
      <h3 id="modal-title">–ü—Ä–µ–º–∏—É–º</h3>
      <p class="hint">–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏</p>
      
      <p class="price" id="modal-price">499 ‚ÇΩ</p>
      
      <div class="modal-info-block">
        <p class="hint center">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É –Ω–∞ –Ω–æ–º–µ—Ä:</p>
        <div class="modal-phone" id="modal-phone">+7 (999) 123-45-67</div>
      </div>
      
      <div style="display: flex; gap: 12px;">
        <button class="btn secondary" onclick="App.copyPhone()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="btn primary" onclick="App.confirmPayment()">
            –Ø –æ–ø–ª–∞—Ç–∏–ª
        </button>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="subscriptions">
      <!-- Rounded, cleaner icons -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      <div>–ü–æ–¥–ø–∏—Å–∫–∏</div>
    </div>
    <div class="nav-item" data-tab="purchase">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
      <div>–¢–∞—Ä–∏—Ñ—ã</div>
    </div>
    <div class="nav-item" data-tab="tutorial">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
      <div>–ò–Ω—Ñ–æ</div>
    </div>
    <div class="nav-item" data-tab="support">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
      <div>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
    </div>
    <div class="nav-item" data-tab="admin" id="admin-tab">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      <div>–ê–¥–º–∏–Ω</div>
    </div>
  </nav>

  <div id="toast"></div>
</body>
</html>
