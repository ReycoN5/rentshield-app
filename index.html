<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Remnawave</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAkRl7PNxZHQIPiqCbmoTbOdLteKJ8DWwI",
        authDomain: "servicehub-e6821.firebaseapp.com",
        projectId: "servicehub-e6821",
        storageBucket: "servicehub-e6821.firebasestorage.app",
        messagingSenderId: "208780669426",
        appId: "1:208780669426:web:3f141d0d6eecef1a397b6b"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const ADMIN_IDS = [935754023];

      const PLANS = [
        { id: 'month1', name: '1 месяц', price: 300, duration: '30 дней' },
        { id: 'month3', name: '3 месяца', price: 800, duration: '90 дней' },
        { id: 'month6', name: '6 месяцев', price: 1200, duration: '180 дней' }
      ];

      const PHONE_NUMBER = "+7 (999) 123-45-67"; // Замени на свой

      const App = {
        user: null,
        currentTab: 'subscriptions',
        selectedPlan: null,
        pendingRequest: null,
        subscriptions: [],
        db
      };

      App.initTelegram = () => {
        if (!window.Telegram?.WebApp) return;
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        const tp = Telegram.WebApp.themeParams;
        if (tp) {
          const root = document.documentElement;
          Object.keys(tp).forEach(key => root.style.setProperty(`--${key.replace(/_/g, '-')}`, tp[key]));
        }
      };

      App.showToast = (msg) => {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      };

      App.haptic = (type = 'light') => {
        const valid = ['light', 'medium', 'heavy'];
        if (valid.includes(type) && Telegram?.WebApp?.isVersionAtLeast?.('6.1')) {
          Telegram.WebApp.HapticFeedback.impactOccurred(type);
        }
      };

      App.autoLogin = async () => {
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        if (!tgUser || !tgUser.id) {
          document.getElementById('content').innerHTML = '<p class="hint">Откройте через кнопку в боте</p>';
          return;
        }
        const userId = tgUser.id.toString();
        const username = tgUser.username || tgUser.first_name || 'User';
        const role = ADMIN_IDS.includes(tgUser.id) ? 'admin' : 'user';
        await setDoc(doc(db, "users", userId), { username, role, telegramId: tgUser.id, lastLogin: serverTimestamp() }, { merge: true });
        App.user = { id: userId, username, role };
        document.getElementById('admin-tab').style.display = role === 'admin' ? 'flex' : 'none';
        const nav = document.querySelector('.bottom-nav');
        nav.style.display = 'flex';
        nav.classList.add('show');
        App.loadUserData();
        App.renderCurrentTab();
        App.haptic('light');
        App.showToast(`Привет, ${username}`);
      };

      App.loadUserData = () => {
        onSnapshot(query(collection(db, "subscriptions"), where("userId", "==", App.user.id)), (snap) => {
          App.subscriptions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          App.renderCurrentTab();
        });
        onSnapshot(query(collection(db, "paymentRequests"), where("userId", "==", App.user.id), where("status", "==", "pending")), (snap) => {
          App.pendingRequest = snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() };
          document.getElementById('status-badge').classList.toggle('show', !!App.pendingRequest);
          App.renderCurrentTab();
        });
      };

      App.showPaymentModal = (plan) => {
        App.selectedPlan = plan;
        document.getElementById('modal-title').textContent = plan.name;
        document.getElementById('modal-price').textContent = `${plan.price} ₽`;
        document.getElementById('modal-phone').textContent = PHONE_NUMBER;
        document.getElementById('payment-modal').classList.add('show');
        App.haptic('medium');
      };

      App.copyPhone = () => {
        navigator.clipboard.writeText(PHONE_NUMBER);
        App.showToast('Номер скопирован');
        App.haptic('light');
      };

      App.confirmPayment = async () => {
        if (App.pendingRequest) {
          App.showToast('Заявка уже отправлена');
          return;
        }
        const ref = doc(collection(db, "paymentRequests"));
        await setDoc(ref, {
          userId: App.user.id,
          username: App.user.username,
          planId: App.selectedPlan.id,
          planName: App.selectedPlan.name,
          price: App.selectedPlan.price,
          status: 'pending',
          createdAt: serverTimestamp()
        });
        document.getElementById('payment-modal').classList.remove('show');
        App.showToast('Заявка отправлена! Ожидайте подтверждения');
      };

      App.renderCurrentTab = () => {
        const content = document.getElementById('content');
        const title = document.getElementById('page-title');
        content.innerHTML = '';
        title.textContent = '';

        if (App.currentTab === 'subscriptions') {
          title.textContent = 'Мои подписки';
          if (App.subscriptions.length === 0) {
            content.innerHTML = '<p class="hint center">Нет активных подписок</p>';
          } else {
            App.subscriptions.forEach(sub => {
              const card = document.createElement('div');
              card.className = 'card fade-in';
              card.innerHTML = `
                <h3>${sub.planName}</h3>
                <p class="status">Активна</p>
                ${sub.connectionLink ? `<p class="link">${sub.connectionLink}</p>` : ''}
                ${sub.qrBase64 ? `<img src="${sub.qrBase64}" class="qr">` : ''}
                ${sub.connectionLink ? `<button class="btn secondary" onclick="navigator.clipboard.writeText('${sub.connectionLink}'); App.showToast('Скопировано')">Скопировать</button>` : ''}
              `;
              content.appendChild(card);
            });
          }
        } else if (App.currentTab === 'purchase') {
          title.textContent = 'Выберите тариф';
          PLANS.forEach(plan => {
            const card = document.createElement('div');
            card.className = 'plan-card fade-in';
            card.onclick = () => App.showPaymentModal(plan);
            card.innerHTML = `
              <h3>${plan.name}</h3>
              <p class="price">${plan.price} ₽</p>
              <p class="duration">${plan.duration}</p>
            `;
            content.appendChild(card);
          });
        } else if (App.currentTab === 'tutorial') {
          title.textContent = 'Как подключиться';
          content.innerHTML = `
            <div class="card fade-in"><h3>1. Скачайте v2RayTun</h3><p>iOS / Android</p></div>
            <div class="card fade-in"><h3>2. Скопируйте ссылку</h3><p>Из "Мои подписки"</p></div>
            <div class="card fade-in"><h3>3. Вставьте или отсканируйте QR</h3></div>
          `;
        } else if (App.currentTab === 'admin') {
          if (App.user.role !== 'admin') return;
          title.textContent = 'Админ';
          content.innerHTML = '<p class="hint">Загрузка...</p>';
          App.renderAdminPanel();
        }
      };

      App.renderAdminPanel = async () => {
        const content = document.getElementById('content');
        content.innerHTML = '<h3 class="section-title">Заявки</h3>';
        const snap = await getDocs(query(collection(db, "paymentRequests"), where("status", "==", "pending")));
        if (snap.empty) {
          content.innerHTML += '<p class="hint center">Нет заявок</p>';
          return;
        }
        snap.forEach(d => {
          const req = { id: d.id, ...d.data() };
          const card = document.createElement('div');
          card.className = 'card fade-in';
          card.innerHTML = `
            <p><strong>${req.username || req.userId}</strong></p>
            <p class="hint">${req.createdAt?.toDate()?.toLocaleString() || 'Недавно'}</p>
            <input type="text" placeholder="Ссылка" id="link-${req.id}">
            <input type="file" accept="image/*" id="qr-${req.id}">
            <div id="preview-${req.id}" class="preview"></div>
            <button class="btn primary" onclick="App.confirmPayment('${req.id}')">Выдать</button>
          `;
          content.appendChild(card);
          document.getElementById(`qr-${req.id}`).onchange = e => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = ev => document.getElementById(`preview-${req.id}`).innerHTML = `<img src="${ev.target.result}" class="qr">`;
              reader.readAsDataURL(file);
            }
          };
        });
      };

      App.onPaidClick = async () => {
        if (App.pendingRequest) return App.showToast('Заявка уже отправлена');
        const ref = doc(collection(db, "paymentRequests"));
        await setDoc(ref, { userId: App.user.id, username: App.user.username, status: 'pending', createdAt: serverTimestamp() });
        App.showToast('Заявка отправлена');
      };

      window.App = App;

      App.confirmPayment = async (id) => {
        const link = document.getElementById(`link-${id}`).value.trim();
        const qrFile = document.getElementById(`qr-${id}`).files[0];
        let qrBase64 = '';
        if (qrFile) {
          qrBase64 = await new Promise(r => {
            const reader = new FileReader();
            reader.onload = e => r(e.target.result);
            reader.readAsDataURL(qrFile);
          });
        }
        if (!link && !qrBase64) return App.showToast('Добавьте ссылку или QR');
        const req = await getDoc(doc(db, "paymentRequests", id));
        await setDoc(doc(collection(db, "subscriptions")), {
          userId: req.data().userId,
          planName: 'Премиум',
          status: 'active',
          connectionLink: link,
          qrBase64,
          createdAt: serverTimestamp()
        });
        await updateDoc(doc(db, "paymentRequests", id), { status: 'confirmed' });
        App.showToast('Подписка выдана');
        App.renderAdminPanel();
      };

      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', e => {
          document.querySelector('.nav-item.active')?.classList.remove('active');
          e.currentTarget.classList.add('active');
          App.currentTab = e.currentTarget.dataset.tab;
          App.renderCurrentTab();
          App.haptic('light');
        });
      });

      App.initTelegram();
      App.autoLogin();
    </script>

    <style>
      :root { --bg:#000; --text:#fff; --hint:#aaa; --link:#0a84ff; --button:#0a84ff; --button-text:#fff; --secondary:#1c1c1e; }
      *{margin:0;padding:0;box-sizing:border-box;}
      body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden;}
      .container{padding:32px 24px;padding-bottom:100px;max-width:480px;margin:0 auto;}
      h2{font-size:28px;font-weight:700;text-align:center;margin-bottom:40px;}
      .card{background:var(--secondary);border-radius:24px;padding:28px;margin-bottom:24px;box-shadow:0 8px 32px rgba(0,0,0,0.4);backdrop-filter:blur(10px);animation:fadeIn 0.5s ease-out;}
      .plan-card{cursor:pointer;transition:transform 0.2s, box-shadow 0.2s;}
      .plan-card:active{transform:scale(0.96);}
      .plan-card h3{font-size:20px;font-weight:600;margin-bottom:12px;}
      .plan-card .price{font-size:36px;font-weight:700;color:var(--link);margin:16px 0;}
      .plan-card .duration{font-size:16px;color:var(--hint);}
      .hint{font-size:15px;color:var(--hint);text-align:center;margin:32px 0;}
      .link{font-size:14px;word-break:break-all;color:var(--hint);margin:20px 0;}
      .qr{width:100%;border-radius:20px;margin:24px 0;}
      .status{font-size:14px;padding:8px 16px;background:rgba(0,255,0,0.2);color:#0f0;border-radius:16px;display:inline-block;}
      .btn{background:var(--button);color:var(--button-text);border:none;border-radius:20px;padding:18px;font-size:18px;font-weight:600;width:100%;cursor:pointer;transition:transform 0.1s;}
      .btn:active{transform:scale(0.96);}
      .btn.secondary{background:rgba(255,255,255,0.1);}
      .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);padding:12px 20px env(safe-area-inset-bottom);display:none;justify-content:space-around;border-top:1px solid rgba(255,255,255,0.05);animation:slideUp 0.5s ease-out;}
      .nav-item{text-align:center;color:var(--hint);font-size:11px;padding:10px;border-radius:20px;transition:all 0.2s;flex:1;}
      .nav-item.active{color:var(--link);background:rgba(10,132,255,0.15);}
      .nav-item svg{width:28px;height:28px;display:block;margin:0 auto 8px;}
      #toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:white;padding:16px 32px;border-radius:32px;opacity:0;transition:opacity 0.3s, transform 0.3s;z-index:1000;font-size:16px;}
      #toast.show{opacity:1;transform:translateX(-50%) translateY(-10px);}
      #status-badge{position:fixed;top:24px;right:24px;background:#ff9f0a;color:#000;padding:12px 24px;border-radius:32px;font-weight:600;font-size:15px;opacity:0;transition:opacity 0.3s;z-index:90;}
      #status-badge.show{opacity:1;}
      .modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);display:none;align-items:flex-end;justify-content:center;z-index:200;animation:fadeIn 0.3s;}
      .modal.show{display:flex;}
      .modal-content{background:var(--secondary);border-radius:32px 32px 0 0;padding:32px;width:100%;max-width:500px;animation:slideUpModal 0.4s ease-out;}
      .modal h3{font-size:24px;font-weight:700;margin-bottom:16px;text-align:center;}
      .modal .price{font-size:40px;font-weight:700;color:var(--link);text-align:center;margin:20px 0;}
      .modal-phone{background:rgba(255,255,255,0.1);border-radius:20px;padding:20px;text-align:center;font-size:20px;font-weight:600;margin:24px 0;}
      @keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
      @keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
      @keyframes slideUpModal{from{transform:translateY(100%);}to{transform:translateY(0);}}
      .center{text-align:center;}
    </style>
</head>
<body>
  <div id="main-app">
    <div id="status-badge">Ожидание подтверждения...</div>
    <div class="container">
      <h2 id="page-title">Remnawave</h2>
      <div id="content">
        <p class="hint center">Авторизация...</p>
      </div>
    </div>
  </div>

  <!-- Модальное окно оплаты -->
  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title">Премиум</h3>
      <p class="price" id="modal-price">499 ₽</p>
      <p class="hint">Переведите на номер телефона:</p>
      <div class="modal-phone" id="modal-phone">+7 (999) 123-45-67</div>
      <button class="btn secondary" onclick="App.copyPhone()">Скопировать номер</button>
      <button class="btn primary" onclick="App.confirmPayment()" style="margin-top:16px;">Я оплатил</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="subscriptions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2"/></svg>
      <div>Подписки</div>
    </div>
    <div class="nav-item" data-tab="purchase">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h2l.4 2M7.5 13h9l4-8H6m1.5 8L6 5m1.5 8-2.3 2.3a1.8 1.8 0 00.8 3h12a2 2 0 100-4h-12"/></svg>
      <div>Оформить</div>
    </div>
    <div class="nav-item" data-tab="tutorial">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6v6l4 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      <div>Обучение</div>
    </div>
    <div class="nav-item" data-tab="admin" id="admin-tab">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-8 0v2m4-10a4 4 0 100-8 4 4 0 000 8z"/></svg>
      <div>Админ</div>
    </div>
  </nav>

  <div id="toast"></div>
</body>
</html>
