<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Remnawave</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAkRl7PNxZHQIPiqCbmoTbOdLteKJ8DWwI",
        authDomain: "servicehub-e6821.firebaseapp.com",
        projectId: "servicehub-e6821",
        storageBucket: "servicehub-e6821.firebasestorage.app",
        messagingSenderId: "208780669426",
        appId: "1:208780669426:web:3f141d0d6eecef1a397b6b"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const ADMIN_IDS = [935754023];

      const App = {
        user: null,
        currentTab: 'subscriptions',
        pendingRequest: null,
        subscriptions: [],
        db
      };

      App.initTelegram = () => {
        if (!window.Telegram?.WebApp) return;
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const tp = Telegram.WebApp.themeParams;
        if (tp) {
          const root = document.documentElement;
          root.style.setProperty('--bg', tp.bg_color || '#000');
          root.style.setProperty('--text', tp.text_color || '#fff');
          root.style.setProperty('--hint', tp.hint_color || '#aaa');
          root.style.setProperty('--link', tp.link_color || '#0a84ff');
          root.style.setProperty('--button', tp.button_color || '#0a84ff');
          root.style.setProperty('--button-text', tp.button_text_color || '#fff');
          root.style.setProperty('--secondary-bg', tp.secondary_bg_color || '#111');
        }
      };

      App.showToast = (msg) => {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      };

      App.haptic = (type = 'light') => {
        if (Telegram?.WebApp?.isVersionAtLeast?.('6.1')) {
          Telegram.WebApp.HapticFeedback.impactOccurred(type);
        }
      };

      App.autoLogin = async () => {
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        if (!tgUser || !tgUser.id) {
          document.getElementById('content').innerHTML = '<p class="hint">Откройте через кнопку в боте</p>';
          return;
        }

        const userId = tgUser.id.toString();
        const username = tgUser.username || tgUser.first_name || 'User';
        const role = ADMIN_IDS.includes(tgUser.id) ? 'admin' : 'user';

        await setDoc(doc(db, "users", userId), { username, role, telegramId: tgUser.id, lastLogin: serverTimestamp() }, { merge: true });

        App.user = { id: userId, username, role };
        document.getElementById('admin-tab').style.display = role === 'admin' ? 'flex' : 'none';
        document.querySelector('.bottom-nav').classList.add('show');

        App.loadUserData();
        App.renderCurrentTab();
        App.haptic('light');
        App.showToast(`Привет, ${username}`);
      };

      App.loadUserData = () => {
        onSnapshot(query(collection(db, "subscriptions"), where("userId", "==", App.user.id)), (snap) => {
          App.subscriptions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          App.renderCurrentTab();
        });
        onSnapshot(query(collection(db, "paymentRequests"), where("userId", "==", App.user.id), where("status", "==", "pending")), (snap) => {
          App.pendingRequest = snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() };
          document.getElementById('status-badge').classList.toggle('show', !!App.pendingRequest);
          App.renderCurrentTab();
        });
      };

      App.renderCurrentTab = () => {
        const content = document.getElementById('content');
        const title = document.getElementById('page-title');
        content.innerHTML = '';
        title.textContent = '';

        if (App.currentTab === 'subscriptions') {
          title.textContent = 'Мои подписки';
          if (App.subscriptions.length === 0) {
            content.innerHTML = '<p class="hint center">Нет активных подписок</p>';
          } else {
            App.subscriptions.forEach(sub => {
              const card = document.createElement('div');
              card.className = 'card fade-in';
              card.innerHTML = `
                <h3>${sub.planName || 'Премиум'}</h3>
                <p class="status active">Активна</p>
                ${sub.connectionLink ? `<p class="link">${sub.connectionLink}</p>` : ''}
                ${sub.qrBase64 ? `<img src="${sub.qrBase64}" class="qr">` : ''}
                ${sub.connectionLink ? `<button class="btn secondary" onclick="navigator.clipboard.writeText('${sub.connectionLink}'); App.showToast('Скопировано')">Скопировать</button>` : ''}
              `;
              content.appendChild(card);
            });
          }
        } else if (App.currentTab === 'purchase') {
          title.textContent = 'Оформление';
          content.innerHTML = `
            <div class="card fade-in">
              <h3>Премиум</h3>
              <p class="price">499 ₽ / месяц</p>
              <p class="hint">Оплата через СБП</p>
              <p class="details">Реквизиты:<br><span class="mono">[ВСТАВЬ СВОИ]</span></p>
              <button class="btn primary" id="paid-btn">${App.pendingRequest ? 'Ожидание подтверждения' : 'Я оплатил'}</button>
            </div>
          `;
          const btn = document.getElementById('paid-btn');
          if (btn) btn.addEventListener('click', App.onPaidClick);
        } else if (App.currentTab === 'tutorial') {
          title.textContent = 'Как подключиться';
          content.innerHTML = `
            <div class="card fade-in"><h3>1. Скачайте приложение</h3><p>v2RayTun (iOS / Android)</p></div>
            <div class="card fade-in"><h3>2. Скопируйте ссылку</h3><p>Из раздела "Мои подписки"</p></div>
            <div class="card fade-in"><h3>3. Вставьте в приложение</h3><p>Или отсканируйте QR-код</p></div>
          `;
        } else if (App.currentTab === 'admin') {
          if (App.user.role !== 'admin') return;
          title.textContent = 'Админ';
          content.innerHTML = '<p class="hint">Загрузка заявок...</p>';
          App.renderAdminPanel();
        }
      };

      App.renderAdminPanel = async () => {
        const content = document.getElementById('content');
        content.innerHTML = '<h3 class="section-title">Заявки</h3>';
        const snap = await getDocs(query(collection(db, "paymentRequests"), where("status", "==", "pending")));
        if (snap.empty) {
          content.innerHTML += '<p class="hint center">Нет заявок</p>';
          return;
        }
        snap.forEach(d => {
          const req = { id: d.id, ...d.data() };
          const card = document.createElement('div');
          card.className = 'card fade-in';
          card.innerHTML = `
            <p><strong>${req.username || req.userId}</strong></p>
            <p class="hint">${req.createdAt?.toDate()?.toLocaleString() || 'Недавно'}</p>
            <input type="text" placeholder="Ссылка" id="link-${req.id}">
            <input type="file" accept="image/*" id="qr-${req.id}">
            <div id="preview-${req.id}" class="preview"></div>
            <button class="btn primary" onclick="App.confirmPayment('${req.id}')">Выдать</button>
          `;
          content.appendChild(card);
          document.getElementById(`qr-${req.id}`).onchange = e => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = ev => document.getElementById(`preview-${req.id}`).innerHTML = `<img src="${ev.target.result}" class="qr">`;
              reader.readAsDataURL(file);
            }
          };
        });
      };

      App.onPaidClick = async () => {
        if (App.pendingRequest) return App.showToast('Заявка уже отправлена');
        const ref = doc(collection(db, "paymentRequests"));
        await setDoc(ref, { userId: App.user.id, username: App.user.username, status: 'pending', createdAt: serverTimestamp() });
        App.showToast('Заявка отправлена');
      };

      window.App = App;

      App.confirmPayment = async (id) => {
        const link = document.getElementById(`link-${id}`).value.trim();
        const qrFile = document.getElementById(`qr-${id}`).files[0];
        let qrBase64 = '';
        if (qrFile) {
          qrBase64 = await new Promise(r => {
            const reader = new FileReader();
            reader.onload = e => r(e.target.result);
            reader.readAsDataURL(qrFile);
          });
        }
        if (!link && !qrBase64) return App.showToast('Добавьте ссылку или QR');
        const req = await getDoc(doc(db, "paymentRequests", id));
        await setDoc(doc(collection(db, "subscriptions")), {
          userId: req.data().userId,
          planName: 'Премиум',
          status: 'active',
          connectionLink: link,
          qrBase64,
          createdAt: serverTimestamp()
        });
        await updateDoc(doc(db, "paymentRequests", id), { status: 'confirmed' });
        App.showToast('Подписка выдана');
        App.renderAdminPanel();
      };

      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', e => {
          document.querySelector('.nav-item.active')?.classList.remove('active');
          e.currentTarget.classList.add('active');
          App.currentTab = e.currentTarget.dataset.tab;
          App.renderCurrentTab();
          App.haptic('selection');
        });
      });

      App.initTelegram();
      App.autoLogin();
    </script>

    <style>
      :root {
        --bg: #000;
        --text: #fff;
        --hint: #aaa;
        --link: #0a84ff;
        --button: #0a84ff;
        --button-text: #fff;
        --secondary-bg: #111;
      }
      * { margin:0; padding:0; box-sizing:border-box; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow:hidden; }
      .container { padding:24px; padding-bottom:100px; }
      h2 { font-size:28px; font-weight:700; text-align:center; margin-bottom:32px; }
      h3 { font-size:20px; font-weight:600; margin-bottom:8px; }
      .card { background:var(--secondary-bg); border-radius:20px; padding:24px; margin-bottom:20px; box-shadow:0 4px 20px rgba(0,0,0,0.3); animation:fadeIn 0.4s ease-out; }
      .price { font-size:32px; font-weight:700; color:var(--link); margin:16px 0; }
      .hint { font-size:15px; color:var(--hint); text-align:center; margin:20px 0; }
      .link { font-size:13px; word-break:break-all; color:var(--hint); margin:16px 0; }
      .qr { width:100%; border-radius:16px; margin:20px 0; }
      .status { font-size:14px; padding:6px 12px; background:rgba(0,200,0,0.2); color:#0f0; border-radius:12px; display:inline-block; }
      .btn { background:var(--button); color:var(--button-text); border:none; border-radius:16px; padding:16px; font-size:17px; font-weight:600; width:100%; cursor:pointer; transition:transform 0.1s, opacity 0.2s; }
      .btn:active { transform:scale(0.96); }
      .btn.secondary { background:rgba(255,255,255,0.1); color:var(--text); }
      .btn.primary { box-shadow:0 8px 20px rgba(10,132,255,0.3); }
      .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(20px); padding:12px 16px env(safe-area-inset-bottom); display:none; justify-content:space-around; border-top:1px solid rgba(255,255,255,0.05); animation:slideUp 0.4s ease-out; }
      .nav-item { text-align:center; color:var(--hint); font-size:11px; padding:8px; border-radius:16px; transition:all 0.2s; flex:1; }
      .nav-item.active { color:var(--link); background:rgba(10,132,255,0.15); }
      .nav-item svg { width:28px; height:28px; display:block; margin:0 auto 6px; }
      #toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); color:white; padding:14px 28px; border-radius:30px; opacity:0; transition:opacity 0.3s, transform 0.3s; z-index:1000; font-size:16px; }
      #toast.show { opacity:1; transform:translateX(-50%) translateY(-10px); }
      #status-badge { position:fixed; top:20px; right:20px; background:#ff9f0a; color:#000; padding:10px 20px; border-radius:30px; font-weight:600; font-size:14px; opacity:0; transition:opacity 0.3s; z-index:90; }
      #status-badge.show { opacity:1; }
      @keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
      @keyframes slideUp { from { transform:translateY(100%); } to { transform:translateY(0); } }
      .center { text-align:center; }
      .mono { font-family:monospace; }
      .section-title { font-size:22px; font-weight:600; margin:24px 0 16px; text-align:center; }
      .preview { margin:20px 0; text-align:center; }
    </style>
</head>
<body>
  <div id="main-app">
    <div id="status-badge">Ожидание подтверждения...</div>
    <div class="container">
      <h2 id="page-title">Remnawave</h2>
      <div id="content">
        <p class="hint center">Авторизация...</p>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="subscriptions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2"/></svg>
      <div>Подписки</div>
    </div>
    <div class="nav-item" data-tab="purchase">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h2l.4 2M7.5 13h9l4-8H6m1.5 8L6 5m1.5 8-2.3 2.3a1.8 1.8 0 00.8 3h12a2 2 0 100-4h-12"/></svg>
      <div>Оформить</div>
    </div>
    <div class="nav-item" data-tab="tutorial">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6v6l4 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      <div>Обучение</div>
    </div>
    <div class="nav-item" data-tab="admin" id="admin-tab">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-8 0v2m4-10a4 4 0 100-8 4 4 0 000 8z"/></svg>
      <div>Админ</div>
    </div>
  </nav>

  <div id="toast"></div>
</body>
</html>
